<!DOCTYPE html>
<html lang="pt-BR">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Layout Argenzio</title>
	<link rel="stylesheet" href="/css/stylemenu.css" />
	<link rel="stylesheet" href="/css/stylerelatorios.css" />
	<script defer src="/js/menu-active.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
	<aside class="sidebar">
		<div class="profile">
			<div class="avatar"></div>
			<div class="user-info">
				<span class="user-name"><%= usuario %></span>
				<span class="user-role"><%= roles %></span>
			</div>
		</div>

		<div class="menu-wrapper">
			<nav class="menu">
			<% if (!roles.includes('atendente')) { %>
				<a href="/auditoria" class="menu-btn clock" aria-label="Relógio" title="Auditoria"></a>
			<% } %>
			<a href="/config" class="menu-btn settings" aria-label="Configurações" title="Configurações"></a>
			<!-- <a href="/relatorios" class="menu-btn stats" aria-label="Estatísticas" title="Rendimento"></a> -->
			<a href="/relatorios" class="menu-btn stats" aria-label="Estatísticas" title="Avaliações"></a>
			</nav>
		</div>
	</aside>

	<main class="main-content">
		<div class="logo"></div>
		<div class="mainDashboard">
			<h2 id="tituloRelatorio">Relatório: Notas das Vendas</h2>
			<div class="containerBotoesMudarRelatorio">
				<!-- <button id="alternarRelatorios" class="botaoMudarRelatorio">Alternar relatório</button> -->

				<button id="avaliacoesVendas" class="botaoMudarRelatorio">Ver notas das Vendas</button>
				<button id="avaliacoesProdutos" class="botaoMudarRelatorio">Ver notas dos Produtos</button>
				<button id="avaliacoesAtendimento" class="botaoMudarRelatorio">Ver notas do Atentimento</button>

				<!-- <button id="rendimento">Atualizar rendimento</button> -->

				<a href="/relatorios/nova_avaliacao" id="novaAvaliacao" class="botaoMudarRelatorio" style="text-decoration: none;">Nova Avaliação</a>
			</div>
			<div id="relatorio">
				<!-- <canvas id="graficoChartJs">

				</canvas> -->
				<div class="bg-gray-800 p-4 rounded-xl shadow-lg">
					<h2 class="text-xl font-semibold mb-4 text-center text-green-400">Melhores Avaliados</h2>
					<div class="relative h-96">
						<canvas class="graficoChartJs graficoMelhores"></canvas>
					</div>
				</div>

				<div class="bg-gray-800 p-4 rounded-xl shadow-lg">
					<h2 class="text-xl font-semibold mb-4 text-center text-red-400">Piores Avaliados</h2>
					<div class="relative h-96">
						<canvas class="graficoChartJs graficoPiores"></canvas>
					</div>
				</div>
			</div>
		</div>
	</main>
	<script>
		"use strict";

		const avalButton = document.getElementById("avaliacoes");
		const avalVendasButton = document.getElementById("avaliacoesVendas");
		const avalProdutosButton = document.getElementById("avaliacoesProdutos");
		const avalAtendimentoButton = document.getElementById("avaliacoesAtendimento");

		const botoes = document.getElementsByClassName("botaoMudarRelatorio");
		const ctx = document.getElementById('graficoChartJs');
		let avaliacoes;
		let grafico;
		
		async function alternarRelatorio()
		{
			if(relatorioAtual === 0)
			{
				for(const btn in botoes)
				{
					if(btn.id in ['avaliacoes', 'avaliacoesVendas', 'avaliacoesProdutos', 'avaliacoesAtendimento'])
					{
						btn.style.display = "none";
					}
					else
					{
						btn.style.display = "";
					}
				}
			}
		}

		async function atualizarRelatorios(categoria){
			const preElem = document.getElementById("teste");

			const result = await fetch(`http://localhost:4040/relatorios/avaliacaoclientes/${categoria}`);
			const data = await result.json();
			
			avaliacoes = data;
		}

		avalVendasButton.onclick = async () => {
			atualizarSelecionado(avalVendasButton);
			await atualizarRelatorios("vendedores");
			criarGrafico("line");
		}
		avalProdutosButton.onclick = async () => {
			atualizarSelecionado(avalProdutosButton);
			await atualizarRelatorios("produtos");
			criarGrafico("line");
		}
		avalAtendimentoButton.onclick = async () => {
			atualizarSelecionado(avalAtendimentoButton);
			await atualizarRelatorios("atendimento");
			criarGrafico("bar");
		}
		
		function criarGrafico(tipoGrafico)
		{
			grafico?.destroy();
			grafico = new Chart(ctx, {
				type: tipoGrafico,
				data: {
					labels: avaliacoes?.labels,
					datasets: [{
						label: 'Nota',
						data: avaliacoes?.notas,
						borderWidth: 2
					}]
				},
				options: {
					scales: { y: { beginAtZero: true } },
					animation: {
						animateRotate: true,
						animateScale: true
					}
				}
			});
		}
		
		function atualizarSelecionado(btn)
		{
			for(let i=0; i<botoes.length; i++)
			{
				botoes[i].className = "botaoMudarRelatorio";
			}

			btn.className = "botaoMudarRelatorio selecionado";
		}
	</script>
</body>
</html>

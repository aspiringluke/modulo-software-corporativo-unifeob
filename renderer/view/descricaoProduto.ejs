<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/stylemenu.css" />
    <link rel="stylesheet" href="/css/styledescricaoprodutos.css">
    <script defer src="/js/menu-active.js"></script>
    <title>Avaliações dos Produtos</title>
</head>
<body>
    <aside class="sidebar">
        <div class="profile">
            <div class="avatar"></div>
            <div class="user-info">
                <span class="user-name"><%= usuario %></span>
                <span class="user-role"><%= roles %></span>
            </div>
        </div>

        <div class="menu-wrapper">
            <nav class="menu">
            <% if (!roles.includes('atendente')) { %>
                <a href="/auditoria" class="menu-btn clock" aria-label="Relógio" title="Auditoria"></a>
            <% } %>
            <a href="/relatorios" class="menu-btn stats" aria-label="Estatísticas" title="Avaliações"></a>
            <a href="/descricoes/produtos" class="menu-btn produto" aria-label="Descrição dos Produtos" title="Descrição dos Produtos"></a>
            </nav>
        </div>
    </aside>

    <main class="main-content">
        <div class="mainContent-container">
            <h1>Avaliações Recentes</h1>

            <div class="filtragem">
                <select class="buttonsFiltragem" id="campoFiltro">
                    <option value="id">ID da Avaliação</option>
                    <option value="descricao">Conteúdo da descrição da avaliação</option>
                    <option value="nota">Nota</option>
                    <option value="produto">Nome do produto</option>
                    <option value="cliente">Nome do cliente</option>
                </select>
                <select class="buttonsFiltragem" id="operadorFiltro">
                    <option value="igual">=</option>
                    <option value="maiorQue">&gt;</option>
                    <option value="menorQue">&lt;</option>
                    <option value="diferenteDe">≠</option>
                    <option value="menorOuIgual">≤</option>
                    <option value="maiorOuIgual">≥</option>
                    <option value="pertence">∈</option>
                </select>
                <input class="buttonsFiltragem" id="valorFiltro" type="text"></input>
            </div>
            <div class="container" id="avaliacoes">
                </div>

            <div id="erro"></div>
        </div>
    </main>

    <script>
        let cards = [];

        function filtrar()
        {
            // ler a expressão de filtragem
            const campo = document.getElementById("campoFiltro");
            const selectedCampo = campo.options[campo.selectedIndex].value;
            const op = document.getElementById("operadorFiltro");
            const valor = document.getElementById("valorFiltro");

            // iterar sobre os cards
            for(const card of cards)
            {
                let a = card.getElementById("idAvaliacao");
                console.log(a);
            }
            // esconder aqueles que não se encaixam na expressão
            // mostrar os que estiverem escondidos e se encaixarem na expressão
            console.log(selectedCampo);
        }

        const valorFiltro = document.getElementById("valorFiltro");
        valorFiltro.addEventListener("input", filtrar);

        function classificarNota(nota) {
            if (nota >= 8) return "nota-alta";
            if (nota >= 5) return "nota-media";
            return "nota-baixa";
        }

        function getIniciais(nome) {
            if (!nome) return "?";
            const partes = nome.split(' ');
            if (partes.length === 1) return partes[0].charAt(0).toUpperCase();
            return (partes[0].charAt(0) + partes[partes.length - 1].charAt(0)).toUpperCase();
        }

        async function carregarAvaliacoes() {
            const loadingEl = document.getElementById("avaliacoes");
            loadingEl.innerHTML = '<p style="color:#666;">Carregando avaliações...</p>';

            try {
                const response = await fetch("http://localhost:4040/relatorios/avaliacaoclientes/produtos?contexto=descricoes");
                const data = await response.json();
                
                loadingEl.innerHTML = '';

                if (!data || !data.idAvaliacao) {
                    document.getElementById("erro").textContent = "Nenhuma avaliação encontrada.";
                    return;
                }

                const container = document.getElementById("avaliacoes");

                data.idAvaliacao.forEach((id, index) => {
                    const idAvaliacao = id;
                    const nota = data.nota[index];
                    const nomeProduto = data.nomeProduto[index] || "Produto sem nome";
                    const descricao = data.descricao[index] || "Sem descrição.";
                    const nomeCliente = data.nomeCliente[index] || "Anônimo";
                    
                    const rawDate = data.data[index];
                    const dataFormatada = rawDate ? new Date(rawDate).toLocaleDateString('pt-BR') : '--/--/----';

                    const card = document.createElement("div");
                    card.classList.add("card");

                    card.innerHTML = `
                        <div class="id-badge" id="idAvaliacao">#${idAvaliacao}</div>
                        
                        <div class="card-header">
                            <div class="nomeProduto">${nomeProduto}</div>
                            <div class="nota ${classificarNota(nota)}">
                                ${nota.toFixed(1)} ★
                            </div>
                        </div>

                        <div class="descricao">
                            "${descricao}"
                        </div>

                        <div class="card-footer">
                            <div class="cliente-info">
                                <div class="avatar-circle">${getIniciais(nomeCliente)}</div>
                                <div class="nomeCliente">${nomeCliente}</div>
                            </div>
                            <div class="data">${dataFormatada}</div>
                        </div>
                    `;

                    container.appendChild(card);
                    cards.push(card);
                });

            } catch (error) {
                document.getElementById("avaliacoes").innerHTML = '';
                document.getElementById("erro").textContent = "Erro de conexão ao carregar avaliações.";
                console.error(error);
            }
        }

        carregarAvaliacoes();
    </script>
</body>
</html>